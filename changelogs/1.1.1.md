# v1.1.1

> Release Date: January 2026

## üö® Breaking Changes

### Replaced crypto-js with Native Node.js Crypto

The library now uses Node.js native `crypto` module instead of `crypto-js`.

**Benefits:**
- ‚ö° **Faster performance** - Uses OpenSSL under the hood
- üì¶ **Zero dependencies** - No external runtime dependencies
- üîí **More secure** - Native implementation with constant-time operations
- üìâ **Smaller bundle** - Reduced by ~8% (28KB ‚Üí 26KB)

**Impact:**
- Keys encrypted with v1.0.x **cannot be decrypted** with v1.1.x
- New encryption format uses binary Buffer instead of WordArray

| Before (crypto-js) | After (native crypto) |
|-------------------|----------------------|
| `CryptoJS.lib.WordArray.random()` | `randomBytes()` |
| `CryptoJS.PBKDF2()` | `pbkdf2Sync()` |
| `CryptoJS.AES.encrypt()` | `createCipheriv()` |
| `CryptoJS.AES.decrypt()` | `createDecipheriv()` |
| `CryptoJS.algo.SHA256` | `createHash('sha256')` |

---

### Singleton Parameter Renamed and Logic Fixed

**Before (v1.0.x - BROKEN):**
```typescript
create({}, true)   // Created new instance (wrong!)
create({}, false)  // Used singleton (wrong!)
```

**After (v1.1.0 - FIXED):**
```typescript
create({})         // Creates new instance (default)
create({}, false)  // Creates new instance
create({}, true)   // Uses singleton
```

**Parameter renamed:** `only` ‚Üí `singleton`

---

## ‚ú® New Features

### FileUtilError Class

Added a dedicated error class for file operations with detailed context:

```typescript
export class FileUtilError extends Error {
  constructor(
    message: string,
    public readonly path: string,
    public readonly operation: 'read' | 'write' | 'delete' | 'access' | 'mkdir',
    public readonly cause?: unknown
  ) {}
}
```

**Usage:**
```typescript
try {
  await fileUtil.read('/nonexistent/path');
} catch (error) {
  if (error instanceof FileUtilError) {
    console.log({
      path: error.path,
      operation: error.operation,
      cause: error.cause,
    });
  }
}
```

---

## üêõ Bug Fixes

### Fixed `checkExists()` Logic

**Before:** Threw error when file didn't exist

**After:** Returns `false` when file doesn't exist (correct behavior)

```typescript
// Before (broken)
async checkExists(path: string): Promise<boolean> {
  try {
    await access(path);
    return true;
  } catch {
    throw new Error(`Failed to check...`); // Wrong!
  }
}

// After (fixed)
async checkExists(path: string): Promise<boolean> {
  try {
    await access(path);
    return true;
  } catch {
    return false; // Correct!
  }
}
```

### Fixed Decrypt Error Handling

**Before:** Threw `bad decrypt` error on wrong password

**After:** Returns empty string `""` on decryption failure (matches crypto-js behavior)

```typescript
const encrypted = crypto.encrypt('secret', 'correct-password');

crypto.decrypt(encrypted, 'correct-password'); // ‚Üí 'secret'
crypto.decrypt(encrypted, 'wrong-password');   // ‚Üí '' (not throw)
crypto.decrypt('corrupted-data', 'password');  // ‚Üí '' (not throw)
```

### Fixed Version Validation

**Before:** Only accepted `string` type for version

**After:** Accepts `stringNumber` (both string and number)

```typescript
// Now validates correctly for numeric versions
const typeChecks = {
  version: 'stringNumber', // Was 'string'
  // ...
};
```

### Fixed JSDoc Documentation

**Before:** Referenced non-existent `originKey` property

**After:** Correctly references `key` property

```typescript
// Before
* // Use expired.originKey ?? ready.originKey safely

// After
* // Use expired?.key ?? ready?.key safely
```

---

## üîß Improvements

### Removed Unsafe Type Casting

Eliminated `as any` type casting in `base.core.ts`:

```typescript
// Before
this.logger = logger as any;

// After
public setLogger(logger: TBaseLogger<TLogger>): this {
  this.logger = logger;
  return this;
}
```

### Optimized sysLog Performance

Changed from async to sync with internal promise handling:

```typescript
// Before (unnecessary async)
public async sysLog(...args): Promise<this> {
  if (!this.bOptions.quiet) await this.logger(...args);
  return this;
}

// After (sync with internal handling)
public sysLog(...args): this {
  if (!this.bOptions.quiet) {
    const result = this.logger(...args);
    if (result && typeof result === 'object' && 'catch' in result) {
      (result as Promise<unknown>).catch(() => {});
    }
  }
  return this;
}
```

### Simplified Class Hierarchy

Removed unnecessary `ConfigEvents` class layer:

```
Before: Base ‚Üí Events ‚Üí ConfigEvents ‚Üí Store ‚Üí KeyManager ‚Üí KM
After:  Base ‚Üí Events ‚Üí Store ‚Üí KeyManager ‚Üí KM
```

---

## üì¶ Dependencies

### Removed Dependencies

| Package | Version | Reason |
|---------|---------|--------|
| `crypto-js` | ^4.2.0 | Replaced with native `crypto` |
| `@types/crypto-js` | ^4.2.2 | No longer needed |

### Current Dependencies

```json
{
  "dependencies": {}  // Zero runtime dependencies! üéâ
}
```

---

## üìã API Changes

### Updated Factory Function

| Parameter | Before | After |
|-----------|--------|-------|
| Name | `only` | `singleton` |
| Default | `true` (broken) | `false` |
| `true` behavior | New instance (wrong) | Singleton |
| `false` behavior | Singleton (wrong) | New instance |

### New Exports

```typescript
export { FileUtilError } from './utils/file.util';
```

---

## ‚¨ÜÔ∏è Migration Guide

### From v1.0.x to v1.1.0

#### 1. Re-generate All Keys (Required)

Due to the crypto engine change, existing keys cannot be decrypted:

```typescript
// Delete old keys and regenerate
const { key, path } = await km.newKey({
  type: 'api',
  duration: 30,
  unit: 'days',
  rotate: true,
});
```

#### 2. Update Singleton Usage

If you used the singleton pattern:

```typescript
// Before (v1.0.x)
const km = create({}, false); // Singleton

// After (v1.1.0)
const km = create({}, true);  // Singleton
```

#### 3. Handle FileUtilError (Optional)

For better error handling:

```typescript
import { FileUtilError } from 'key-rotation-manager';

try {
  // file operations
} catch (error) {
  if (error instanceof FileUtilError) {
    console.error(`File error: ${error.operation} on ${error.path}`);
  }
}
```

---

## üìÅ Files Changed

- `src/utils/crypto.util.ts` - Complete rewrite using native crypto
- `src/utils/file.util.ts` - Added `FileUtilError`, fixed `checkExists()`
- `src/index.ts` - Fixed singleton logic, renamed parameter
- `src/core/base.core.ts` - Removed `as any`, optimized `sysLog`
- `src/core/key-manager.core.ts` - Fixed JSDoc, removed async sysLog calls
- `package.json` - Removed crypto-js dependencies
- `.github/workflows/publish.yml` - Enhanced CI/CD pipeline

---

## üìä Bundle Size Comparison

| Build | v1.0.x | v1.1.0 | Change |
|-------|--------|--------|--------|
| CJS | 28.28 KB | 26.49 KB | -6.3% |
| ESM | 27.44 KB | 26.03 KB | -5.1% |
| Types | 16.20 KB | 19.71 KB | +21.7% |

*Types increased due to `FileUtilError` export*
