# v1.0.10

> Release Date: January 2026

## ‚ú® New Features

### Hooks System

Added a comprehensive hooks system for key lifecycle events. Hooks allow you to execute custom logic when specific events occur.

#### Key Manager Hooks

| Hook | Description | Parameters |
|------|-------------|------------|
| `onKeyNotFound` | Fires when key file is not found or version doesn't exist | `(path: string, version: string \| number)` |
| `onKeyInvalid` | Fires when key validation fails | `(key: TKeyGenerated, message: string, errorOn?: keyof TKeyGenerated)` |
| `onKeyMissingRotateOption` | Fires when expired key needs rotation but options are missing | `(key: TKeyGenerated, options: TGetKeyOptions)` |
| `onKeyRenewed` | Fires when a key is successfully rotated | `(getKey: TGetKey, options: TGetKeyOptions)` |
| `onKeyExpired` | Fires when a key expires but is not renewable | `(path: string, key: TKeyGenerated)` |

#### Base Hooks

| Hook | Description | Parameters |
|------|-------------|------------|
| `onHookNotFound` | Fires when a hook is called but not registered | `(name: string)` |
| `onHookOverriding` | Fires when a hook is being overridden | `(name: string)` |

#### Usage

**Set Multiple Hooks:**

```typescript
keyManager.useHooks({
  onKeyNotFound: (path, version) => {
    console.log(`Key not found: ${path}@${version}`);
  },
  onKeyRenewed: async (getKey, options) => {
    await sendNotification('Key was rotated');
  },
});
```

**Set Single Hook:**

```typescript
keyManager.setHook('onKeyExpired', (path, key) => {
  console.log(`Key expired: ${key.version}`);
});
```

---

### Enhanced gitIgnore Configuration

The `gitIgnore` option now supports flexible path patterns.

#### Type Changes

**Before:** `boolean`

**After:** `boolean | string | string[]`

#### Default Value Change

**Before:** `true`

**After:** `['keys', '*']` ‚Üí adds `keys/*` to `.gitignore`

#### New Features

- **Wildcard Support:** Use `'*'` directly in path arrays
- **Variable Replacement:** `{{variable}}` patterns are converted to `*`
- **Custom Patterns:** Define any custom path pattern

#### Examples

```typescript
// Disable gitignore
create({ gitIgnore: false });

// Full path pattern (path + file + ext)
create({ gitIgnore: true });
// ‚Üí keys/*/v_*.json

// Custom folder with wildcard (default)
create({ gitIgnore: ['keys', '*'] });
// ‚Üí keys/*

// Custom path with variables
create({ gitIgnore: ['secrets', '{{env}}', 'keys'] });
// ‚Üí secrets/*/keys
```

---

## üêõ Bug Fixes

### Fixed .gitignore Exact Line Matching

**Issue:** The previous implementation used `includes()` for checking existing entries, which caused false positives with substring matches.

**Example:** If `.gitignore` had `keys/api/*` and we checked for `keys/*`, it would incorrectly match.

**Fix:** Now uses exact line matching by splitting content and comparing each line.

```typescript
// Before (substring match - problematic)
if (!gitignoreContent.includes(folder))

// After (exact line match)
const gitignoreLines = gitignoreContent.split(/\r?\n/).map((line) => line.trim());
const hasExactLine = gitignoreLines.some((line) => line === folder);
```

### Fixed .gitignore Newline Handling

**Issue:** Windows line endings were not properly handled when appending to `.gitignore`.

**Fix:** Changed from `'\r'` to `'\r\n'` for proper line endings.

---

## üîß Improvements

### Enhanced System Logging

Added `sysLog` calls in `getKey` method for better debugging:

- Key not found events
- Key missing rotate option events
- Key renewed events
- Key expired events
- Key invalid events

```typescript
// Example log output
this.sysLog(`Key not found!`, { path, version });
this.sysLog(`Key renewed!`, { path, version });
this.sysLog(`Key expired!`, { path, version });
```

---

## üì¶ Types

### New Types

```typescript
// Hook types
type TKeyManagerHooks = {
  onKeyMissingRotateOption: (key: TKeyGenerated, options: TGetKeyOptions) => void | Promise<void>;
  onKeyInvalid: (key: TKeyGenerated, message: string, errorOn?: keyof TKeyGenerated) => void | Promise<void>;
  onKeyRenewed: (getKey: TGetKey, options: TGetKeyOptions) => void | Promise<void>;
  onKeyNotFound: (path: string, version: string | number) => void | Promise<void>;
  onKeyExpired: (path: string, key: TKeyGenerated) => void | Promise<void>;
};

type TBaseHooks = {
  onHookNotFound: (name: string) => void;
  onHookOverriding: (name: string) => void;
};

type TModuleHooks = TKeyManagerHooks & TBaseHooks;
```

### Updated Types

```typescript
// gitIgnore now accepts more types
type TKeyFileFormat = `{{${keyof TKeyBindValues}}}` | '*' | '**' | (string & {});
type TFormatUsable = Array<TKeyFileFormat> | TKeyFileFormat;

// In TStoreOptions
gitIgnore: boolean | TFormatUsable;
```

---

## üìã API Changes

### New Methods

| Method | Description | Returns |
|--------|-------------|---------|
| `useHooks(hooks)` | Set multiple hooks at once | `this` (chainable) |
| `setHook(name, handler)` | Set a single hook | `this` (chainable) |

---

## ‚¨ÜÔ∏è Migration Guide

### From v1.0.9 to v1.0.10

**No breaking changes.** All existing code will continue to work.

#### Optional Updates

1. **gitIgnore Default Change:** If you relied on the default `gitIgnore: true` behavior, you may want to explicitly set it:

```typescript
// New default behavior (folder wildcard)
create({ gitIgnore: ['keys', '*'] });
```

2. **Add Hooks:** Consider adding hooks for better observability:

```typescript
keyManager.useHooks({
  onKeyRenewed: (getKey, options) => {
    console.log('Key rotated:', getKey.ready?.version);
  },
  onKeyExpired: (path, key) => {
    console.warn('Key expired:', key.version);
  },
});
```

---

## üìÅ Files Changed

- `src/core/base.core.ts` - Added hooks infrastructure
- `src/core/module.core.ts` - Added `useHooks()` and `setHook()` methods
- `src/core/key-manager.core.ts` - Added hook triggers and system logging
- `src/core/store.core.ts` - Enhanced gitIgnore logic
- `src/types/base.type.ts` - Added `TBaseHooks` type
- `src/types/key-manager.types.ts` - Added `TKeyManagerHooks` type
- `src/types/module.types.ts` - Added `TModuleHooks` type
- `src/types/store.types.ts` - Updated `TKeyFileFormat` and `gitIgnore` type
- `src/constants/default.constant.ts` - Updated default `gitIgnore` value
